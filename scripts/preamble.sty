\usepackage[lang = english, theme = false, numbering = section]{JesseTeX}
\usepackage[natbib = true,
		style = alphabetic,
		sorting = nty,
		url=false,
		giveninits=true,
		maxbibnames=5,
		urldate=iso,
		%date=iso
		]{biblatex}
\DeclareNameAlias{default}{family-given}
\addbibresource{../scripts/references.bib}

\RequirePackage[plainpages = false, pdfpagelabels, citecolor = blue]{hyperref}						% Hyperlinks
\RequirePackage[ocgcolorlinks]{ocgx2}			% This ensures hyperlinks aren't printed (ocgcolorlinks), while still being able to cover multiple lines (as opposed to ocgcolorlinks in hyperref)
\usepackage[a4paper,margin=2.5cm]{geometry}		% Change the shape of a page (custom margins etc.)

\usepackage{imakeidx}
\usepackage{mdframed}                           % Makes boxes around definitions
\usepackage{fancyhdr}

\counterwithin{figure}{section}
\counterwithin{table}{section}
\numberwithin{equation}{section}

\emergencystretch 2em

%%% This is about changing the headers and footers (i.e. Top and bottom of the page)
\pagestyle{fancy}% use fancyheaders with the bar on the top
\fancyhf{} % Clear the normal style
\fancyhead[L]{\bfseries\leftmark} % this places the section number and name in the top left
\fancyhead[R]{\bfseries\thepage} % this places the pagenumber in the top right
% Changing headheight to fit what's inside %
\setlength{\headheight}{24pt}

\DeclareFieldFormat{titlecase}{#1}

%%% Puts definitions, theorems and propositions in boxes
\let\DefOrig\definition
\let\endDefOrig\enddefinition
\renewenvironment{definition}
{%
	\begin{mdframed}[backgroundcolor=gray!15, hidealllines=true, innertopmargin = -5pt, splittopskip=\baselineskip]
	\DefOrig
}
{%
	\endDefOrig
	\end{mdframed}
}%
\let\ThmOrig\theorem
\let\endThmOrig\endtheorem
\renewenvironment{theorem}
{%
	\begin{mdframed}[backgroundcolor=gray!30, hidealllines=true, innertopmargin = -5pt, splittopskip=\baselineskip]
	\ThmOrig
}
{%
	\endThmOrig
	\end{mdframed}
}%
\let\PropOrig\proposition
\let\endPropOrig\endproposition
\renewenvironment{proposition}
{%
	\begin{mdframed}[backgroundcolor=gray!30, hidealllines=true, innertopmargin = -5pt, splittopskip=\baselineskip]
	\PropOrig
}
{%
	\endPropOrig
	\end{mdframed}
}%


%% Theorem replication

\def\thesistemplate@theoremfile{\relax}
\NewDocumentCommand{\theoremfile}{ m }{
 	\def\thesistemplate@theoremfile{exists}
	\RequirePackage{pgfkeys}
}

\AtEndDocument{
	\if\thesistemplate@theoremfile\relax
	\else
		\relax
	\fi
}

\NewDocumentCommand{\makethm}{ m m o +m }{
	% m: the type of theorem environment
	% m: the name of the theorem
	% o: optional parameter for environment
	% m: the content of the theorem
	%
	\IfValueTF{#3}{% Check if theorem has optional arguments
		\begin{#1}[#3]\label{#2}
			#4
		\end{#1}
	}{% No optionals
		\begin{#1}\label{#2}
			#4
		\end{#1}
	}
	\if\thesistemplate@theoremfile\relax
		% No file has been set
		% Saving parameters to macros for later reference
		\expandafter\long\expandafter\gdef\csname thm@#2\endcsname{#4}%
		\expandafter\gdef\csname thmdesc@#2\endcsname{#3}%
		\expandafter\write\expandafter\@auxout{%
			\string\expandafter\string\long\string\expandafter\string\gdef\noexpand\csname thm@#2\string\endcsname{#4}%
			^^J%
			\string\expandafter\string\expandafter\string\gdef\noexpand\csname thmdesc@#2\string\endcsname{#3}%
		}
	\else
		% We have a theorem file
		% Saving parameters in pgfkeys
		\pgfkeyssetvalue{/thesistemplate/#2/thm}{#4}
		\pgfkeyssetvalue{/thesistemplate/#2/thmdesc}{#3}
	\fi
}

\newcounter{old@counter}
\NewDocumentCommand{\repthm}{ m m +o }{
	% m: the type of theorem environment
	% m: the name of the theorem
	% o: alt text
	\begingroup
		\setcounter{old@counter}{\value{#1}}% Save theorem counter so we don't increase it
        \def\thetheorem{\ref{#2}}
		\let\@@theoremnotdefined\relax
		%
		\if\thesistemplate@theoremfile\relax
			% No file has been set
			\ifcsname thm@#2\endcsname% Check if theorem is even defined
				% Theorem is defined
				\expandafter\edef\expandafter\thmdesc{\csname thmdesc@#2\endcsname}%
				\expandafter\let\expandafter\thm\csname thm@#2\endcsname
			\else
				% Theorem undefined
				\let\@@theoremnotdefined 1
			\fi
		\else
			% We have a theorem file
			\pgfkeysifdefined{/thesistemplate/#2/thm}{% Check if theorem is even defined
				% Theorem is defined
				\pgfkeysgetvalue{/thesistemplate/#2/thm}{\thm}
				\pgfkeysgetvalue{/thesistemplate/#2/thmdesc}{\thmdesc}
			}{
				% Theorem undefined
				\let\@@theoremnotdefined 1
			}
		\fi
		\if\@@theoremnotdefined\relax
			% Theorem is defined
			\IfValueTF{\thmdesc}{% Check if theorem has name
				\begin{#1}[\thmdesc]
					\thm
				\end{#1}
			}{% No optionals
				\begin{#1}
					\thm
				\end{#1}
			}
			
		\else
			% Theorem not defined: produce alt text
			\IfValueTF{#3}{
				\begin{#1}
					#3
				\end{#1}
			}{% No theorem or alt text provided: throw warning
				\begin{#1}
				\end{#1}
				\PackageWarning{template}{Theorem #2 not defined; rebuild your project. If the issue persists, create the theorem using \makethm or consider adding alt text to \repthm using the optional parameter}
			}
		\fi
		\setcounter{#1}{\value{old@counter}}% Reset theorem counter back to original
    \endgroup
}